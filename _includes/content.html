<main><div class="container">
  <section>
    <p class="large">
      Griddler is a Rails engine (full plugin) that provides an endpoint for the
      <a href="http://sendgrid.com/docs/API%20Reference/Webhooks/parse.html">SendGrid parse api</a>,
      <a href="http://cloudmailin.com">Cloudmailin parse api</a>,
      <a href="http://developer.postmarkapp.com/developer-inbound-parse.html">Postmark parse api</a> or
      <a href="http://help.mandrill.com/entries/21699367-Inbound-Email-Processing-Overview">Mandrill parse api</a>
      that hands off a built email object to a class implemented by you.
    </p>
  </section>
  <section class="code">
<h2>Tutorials</h2>

<ul>
<li>SendGrid has done a
<a href="http://blog.sendgrid.com/receiving-email-in-your-rails-app-with-griddler/">great tutorial</a>
on integrating Griddler with your application.</li>
<li>And of course, view our own blog post on the subject over at
<a href="http://robots.thoughtbot.com/post/42286882447/handle-incoming-email-with-griddler">Giant Robots</a>.</li>
</ul><h2>Installation</h2>

<p>Add griddler to your application's Gemfile and run <code>bundle install</code>:</p>

<div class="highlight"><pre><span class="n">gem</span> <span class="s1">'griddler'</span>
</pre></div>

<p>Griddler comes with a default endpoint that will be displayed at the bottom
of the output of <code>rake routes</code>. If there is a previously defined route that
matches <code>/email_processor</code> -- or you would like to rename the matched path -- you
may add the route to the desired position in routes.rb with the following:</p>

<div class="highlight"><pre><span class="n">post</span> <span class="s1">'/email_processor'</span> <span class="o">=&gt;</span> <span class="s1">'griddler/emails#create'</span>
</pre></div>

<h2>Defaults</h2>

<p>By default Griddler will look for a class to be created in your application
called EmailProcessor with a class method implemented, named process, taking
in one argument (presumably <code>email</code>). For example, in <code>./lib/email_processor.rb</code>:</p>

<div class="highlight"><pre><span class="k">class</span> <span class="nc">EmailProcessor</span>
  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">process</span><span class="p">(</span><span class="n">email</span><span class="p">)</span>
    <span class="c1"># all of your application-specific code here - creating models,</span>
    <span class="c1"># processing reports, etc</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>

<p>The contents of the <code>email</code> object passed into your process method is an object
that responds to:</p>

<ul>
<li><code>.to</code></li>
<li><code>.from</code></li>
<li><code>.subject</code></li>
<li><code>.body</code></li>
<li><code>.raw_text</code></li>
<li><code>.raw_html</code></li>
<li><code>.raw_body</code></li>
<li><code>.attachments</code></li>
<li><code>.headers</code></li>
<li><code>.raw_headers</code></li>
</ul><p>Each of those has some sensible defaults.</p>

<p><code>.from</code>, <code>.raw_body</code>, <code>.raw_headers</code>, and <code>.subject</code> will contain the obvious
values found in the email, the raw values from those fields.</p>

<p><code>.body</code> will contain the full contents of the email body <strong>unless</strong> there is a
line in the email containing the string <code>-- Reply ABOVE THIS LINE --</code>. In that
case <code>.body</code> will contain everything before that line.</p>

<p><code>.to</code> will contain all of the text before the email's "@" character. We've found
that this is the most often used portion of the email address and consider it to
be the token we'll key off of for interaction with our application.</p>

<p><code>.attachments</code> will contain an array of attachments as multipart/form-data files
which can be passed off to attachment libraries like Carrierwave or Paperclip.</p>

<p><code>.headers</code> will contain a hash of header names and values as parsed by the Mail
gem. Headers will only be parsed if the adapter supports a headers option.</p>

<h2>Configuration Options</h2>

<p>An initializer can be created to control some of the options in Griddler. Defaults
are shown below with sample overrides following. In <code>config/initializer/griddler.rb</code>:</p>

<div class="highlight"><pre><span class="no">Griddler</span><span class="o">.</span><span class="n">configure</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
  <span class="n">config</span><span class="o">.</span><span class="n">processor_class</span> <span class="o">=</span> <span class="no">EmailProcessor</span> <span class="c1"># MyEmailProcessor</span>
  <span class="n">config</span><span class="o">.</span><span class="n">to</span> <span class="o">=</span> <span class="ss">:token</span> <span class="c1"># :full, :email, :hash</span>
  <span class="c1"># :raw    =&gt; 'AppName &lt;s13.6b2d13dc6a1d33db7644@mail.myapp.com&gt;'</span>
  <span class="c1"># :email  =&gt; 's13.6b2d13dc6a1d33db7644@mail.myapp.com'</span>
  <span class="c1"># :token  =&gt; 's13.6b2d13dc6a1d33db7644'</span>
  <span class="c1"># :hash   =&gt; { raw: '', email: '', token: '', host: '' }</span>
  <span class="n">config</span><span class="o">.</span><span class="n">reply_delimiter</span> <span class="o">=</span> <span class="s1">'-- REPLY ABOVE THIS LINE --'</span>
  <span class="n">config</span><span class="o">.</span><span class="n">email_service</span> <span class="o">=</span> <span class="ss">:sendgrid</span>
<span class="k">end</span>
</pre></div>

<ul>
<li>
<code>config.processor_class</code> is the class Griddler will use to handle your incoming emails.</li>
<li>
<code>config.reply_delimiter</code> is the string searched for that will split your body.</li>
<li>
<code>config.to</code> is the format of the returned value for the <code>:to</code> key in
the email object. <code>:hash</code> will return all options within a -- (surprise!) -- hash.</li>
<li>
<code>config.email_service</code> tells Griddler which email service you are using. The supported
email service options are <code>:sendgrid</code> (the default), <code>:cloudmailin</code> (expects
multipart format), <code>:postmark</code> and <code>:mandrill</code>.</li>
</ul><h2>Testing In Your App</h2>

<p>You may want to create a factory for when testing the integration of Griddler into
your application. If you're using factory_girl this can be accomplished with the
following sample factory.</p>

<div class="highlight"><pre><span class="n">factory</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">class</span><span class="p">:</span> <span class="no">OpenStruct</span> <span class="k">do</span>
  <span class="c1"># Assumes Griddler.configure.to is :hash (default)</span>
  <span class="n">to</span> <span class="o">[</span><span class="p">{</span> <span class="ss">raw</span><span class="p">:</span> <span class="s1">'to_user@email.com'</span><span class="p">,</span> <span class="ss">email</span><span class="p">:</span> <span class="s1">'to_user@email.com'</span><span class="p">,</span> <span class="ss">token</span><span class="p">:</span> <span class="s1">'to_user'</span><span class="p">,</span> <span class="ss">host</span><span class="p">:</span> <span class="s1">'email.com'</span> <span class="p">}</span><span class="o">]</span>
  <span class="n">from</span> <span class="s1">'user@email.com'</span>
  <span class="n">subject</span> <span class="s1">'email subject'</span>
  <span class="n">body</span> <span class="s1">'Hello!'</span>
  <span class="n">attachments</span> <span class="p">{</span><span class="o">[]</span><span class="p">}</span>

  <span class="n">trait</span> <span class="ss">:with_attachment</span> <span class="k">do</span>
    <span class="n">attachments</span> <span class="p">{</span><span class="o">[</span>
      <span class="ss">ActionDispatch</span><span class="p">:</span><span class="ss">:Http</span><span class="o">::</span><span class="no">UploadedFile</span><span class="o">.</span><span class="n">new</span><span class="p">({</span>
        <span class="ss">filename</span><span class="p">:</span> <span class="s1">'img.png'</span><span class="p">,</span>
        <span class="ss">type</span><span class="p">:</span> <span class="s1">'image/png'</span><span class="p">,</span>
        <span class="ss">tempfile</span><span class="p">:</span> <span class="no">File</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">"</span><span class="si">#{</span><span class="no">File</span><span class="o">.</span><span class="n">expand_path</span> <span class="no">File</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="bp">__FILE__</span><span class="p">)</span><span class="si">}</span><span class="s2">/fixtures/img.png"</span><span class="p">)</span>
      <span class="p">})</span>
    <span class="o">]</span><span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>

<p>Bear in mind, if you plan on using the <code>:with_attachment</code> trait, that this
example assumes your factories are in <code>spec/factories.rb</code> and you have
an image file in <code>spec/fixtures/</code>.</p>

<p>To use it in your test(s) just build with <code>email = build(:email)</code>
or <code>email = build(:email, :with_attachment)</code>.</p>

<h2>Adapters</h2>

<p><code>Griddler::Email</code> expects certain parameters to be in place for proper parsing
to occur. When writing an adapter, ensure that the <code>normalized_params</code> method
of your adapter returns a hash with these keys:</p>

<ul>
<li>
<code>:to</code> The recipient field</li>
<li>
<code>:from</code> The sender field</li>
<li>
<code>:subject</code> Email subject</li>
<li>
<code>:text</code> The text body of the email</li>
<li>
<code>:html</code> The html body of the email, nil or empty string if not present</li>
<li>
<code>:attachments</code> (can be an empty array) Array of attachments to the email</li>
<li>
<code>:headers</code> (optional) The raw headers of the email</li>
<li>
<code>:charsets</code> (optional) A JSON string containing the character sets of the
fields extracted from the message</li>
</ul><h2>Upgrading to Griddler 0.5.0</h2>

<p>Because of an issue with the way Griddler handled recipients in the <code>To</code> header,
a breaking change was introduced in Griddler 0.5.0 that requires a minor change
to <code>EmailProcessor</code> or <code>processor_class</code>.</p>

<p>Previously, a single address was returned from <code>Griddler::Email#to</code>. Moving
forward, this field will always be an array. Generally speaking, you will want
to do something like this to handle the change:</p>

<div class="highlight"><pre><span class="c1"># before</span>
<span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">email</span><span class="p">)</span>
  <span class="vi">@to</span> <span class="o">=</span> <span class="n">email</span><span class="o">.</span><span class="n">to</span>
  <span class="vi">@from</span> <span class="o">=</span> <span class="n">email</span><span class="o">.</span><span class="n">from</span>
  <span class="vi">@body</span> <span class="o">=</span> <span class="n">email</span><span class="o">.</span><span class="n">body</span>
<span class="k">end</span>

<span class="c1"># after</span>
<span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">email</span><span class="p">)</span>
  <span class="vi">@to</span> <span class="o">=</span> <span class="n">pick_meaningful_recipient</span><span class="p">(</span><span class="n">email</span><span class="o">.</span><span class="n">to</span><span class="p">)</span>
  <span class="vi">@from</span> <span class="o">=</span> <span class="n">email</span><span class="o">.</span><span class="n">from</span>
  <span class="vi">@body</span> <span class="o">=</span> <span class="n">email</span><span class="o">.</span><span class="n">body</span>
<span class="k">end</span>

<span class="kp">private</span>

<span class="k">def</span> <span class="nf">pick_meaningful_recipient</span><span class="p">(</span><span class="n">recipients</span><span class="p">)</span>
  <span class="n">recipients</span><span class="o">.</span><span class="n">find</span> <span class="p">{</span> <span class="o">|</span><span class="n">address</span><span class="o">|</span> <span class="n">address</span> <span class="o">=~</span> <span class="sr">/@mydomain.com$/</span> <span class="p">}</span>
<span class="k">end</span>
</pre></div>

<h2>Using Griddler with Mandrill</h2>

<p>When adding a webhook in their administration panel, Mandrill will issue a HEAD
request to check if the webhook is valid (see
<a href="http://help.mandrill.com/entries/21699367-Inbound-Email-Processing-Overview">Adding Routes</a>).
If the HEAD request fails, Mandrill will not allow you to add the webhook.
Since Griddler is only configured to handle POST requests, you will not be able
to add the webhook as-is. To solve this, add a temporary route to your
application that can handle the HEAD request:</p>

<div class="highlight"><pre><span class="c1"># routes.rb</span>
<span class="n">get</span> <span class="s1">'/email_processor'</span><span class="p">,</span> <span class="ss">:to</span> <span class="o">=&gt;</span> <span class="nb">proc</span> <span class="p">{</span> <span class="o">[</span><span class="mi">200</span><span class="p">,</span> <span class="p">{},</span> <span class="o">[</span><span class="s2">"OK"</span><span class="o">]]</span> <span class="p">}</span>
</pre></div>

<p>Once you have correctly configured Mandrill, you can go ahead and delete this code.</p>

<h2>More Information</h2>

<ul>
<li><a href="http://www.sendgrid.com">SendGrid</a></li>
<li><a href="http://www.sendgrid.com/docs/API%20Reference/Webhooks/parse.html">SendGrid Parse API</a></li>
<li><a href="http://cloudmailin.com">Cloudmailin</a></li>
<li><a href="http://docs.cloudmailin.com/">Cloudmailin Docs</a></li>
<li><a href="http://postmarkapp.com">Postmark</a></li>
<li><a href="http://developer.postmarkapp.com/">Postmark Docs</a></li>
<li><a href="http://mandrill.com">Mandrill</a></li>
<li><a href="http://help.mandrill.com/forums/21092258-Inbound-Email-Processing">Mandrill Docs</a></li>
</ul><h2>Credits</h2>

<p>Griddler was written by Caleb Thompson and Joel Oliveira.</p>

<p>Large portions of the codebase were extracted from thoughtbot's
<a href="http://www.apptrajectory.com">Trajectory</a>.</p>

<p><img src="http://thoughtbot.com/images/tm/logo.png" alt="thoughtbot"></p>

<p>The names and logos for thoughtbot are trademarks of thoughtbot, inc.</p>

<h2>License</h2>

<p>Griddler is Copyright © 2013 Caleb Thompson, Joel Oliveira and thoughtbot. It is
free software, and may be redistributed under the terms specified in the LICENSE
file.</p>
  </section>
</div></main>
